<!DOCTYPE html>
<html>
<head>
  <title></title>
  <link rel="stylesheet" href="/.public/components/codemirror/lib/codemirror.css" />
</head>
<body>


<div id="editor"></div>

<ul id="list"></ul>

<script src="/.public/components/codemirror/lib/codemirror.js"></script>
<script src="/.public/components/codemirror/mode/xml/xml.js"></script>
<script src="/.public/components/codemirror/mode/markdown/markdown.js"></script>
<script src="/.public/components/jquery/dist/jquery.js"></script>
<script src="/.public/js/lib/socket.io-1.0.6.js"></script>
<script src="/.public/components/ot/dist/ot.js"></script>

<script>

// function beginsWith (a, b) { return a.slice(0, b.length) === b; }
// function endsWith (a, b) { return a.slice(a.length - b.length, a.length) === b; }

// function wrap (chars) {
//   cm.operation(function () {
//     if (cm.somethingSelected()) {
//       cm.replaceSelections(cm.getSelections().map(function (selection) {
//         if (beginsWith(selection, chars) && endsWith(selection, chars)) {
//           return selection.slice(chars.length, selection.length - chars.length);
//         }
//         return chars + selection + chars;
//       }), 'around');
//     } else {
//       var index = cm.indexFromPos(cm.getCursor());
//       cm.replaceSelection(chars + chars);
//       cm.setCursor(cm.posFromIndex(index + 2));
//     }
//   });
//   cm.focus();
// }

// function bold ()   { wrap('**'); }
// function italic () { wrap('*'); }
// function code ()   { wrap('`'); }


var EditorClient = ot.EditorClient;
var SocketIOAdapter = ot.SocketIOAdapter;
var CodeMirrorAdapter = ot.CodeMirrorAdapter;

socket = io.connect();
socket.on('doc', function (obj) {
  init(obj.str, obj.revision, obj.clients, new SocketIOAdapter(socket));
});

function login (username, callback) {
  socket
    .emit('editorSync', { path:"doc/m.md", username: username })
    .on('logged_in', callback);
};

var username = new Date();

login(username.toString(), function () {
  var li = document.createElement('li');
  li.appendChild(document.createTextNode(username + " (that's you!)"));
  document.getElementById('list').appendChild(li);

  cmClient.serverAdapter.ownUserName = username;
  cm.setOption('readOnly', false);
});

var cm = window.cm = CodeMirror(document.getElementById('editor'), {
  lineNumbers: true,
  lineWrapping: true,
  mode: 'markdown',
  //readOnly: 'nocursor'
});



function init (str, revision, clients, serverAdapter) {
  cm.setValue(str);
  cmClient = window.cmClient = new EditorClient(
    revision, clients,
    serverAdapter, new CodeMirrorAdapter(cm)
  );
  
  cm.on('change', function () {
    if (!cmClient) { return; }
    // console.log(cmClient.undoManager.canUndo(), cmClient.undoManager.canRedo());
    // (cmClient.undoManager.canUndo() ? enable : disable)(undoBtn);
    // (cmClient.undoManager.canRedo() ? enable : disable)(redoBtn);
  });
}



</script>
</body>
</html>